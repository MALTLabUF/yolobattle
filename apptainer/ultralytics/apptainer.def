Bootstrap: docker
From: ultralytics/ultralytics:latest

%environment
    export DEBIAN_FRONTEND=noninteractive
    export TZ=America/New_York
    export PATH="/usr/local/bin:${PATH}"
    export PYTHONPATH="/opt/app/src:${PYTHONPATH}"
    export DATA_ROOT="/workspace/.cache/datasets"

%files
    src   /opt/app/

%post
    set -eux
    export DEBIAN_FRONTEND=noninteractive
    export TZ=America/New_York
    ln -fs /usr/share/zoneinfo/America/New_York /etc/localtime
    echo "America/New_York" > /etc/timezone
    apt-get update
    apt-get install -y --no-install-recommends tzdata fio
    rm -rf /var/lib/apt/lists/*

    python -m pip install --no-cache-dir --upgrade pip
    python -m pip install --no-cache-dir \
        pycocotools \
        imagesize \
        cloudmesh-common \
        PyYAML \
        Pillow \
        git+https://github.com/cloudmesh/cloudmesh-gpu.git

    mkdir -p /workspace /outputs /ultralytics/.cache /workspace/.cache/datasets
    chmod -R a+rX /workspace /outputs /ultralytics
    chmod -R a+rwX /workspace /outputs /ultralytics/.cache /workspace/.cache

%runscript
    exec python -u -m yolobattle.model_training.train "$@"
