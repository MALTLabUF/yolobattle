Bootstrap: docker
From: nvidia/cuda:12.8.0-cudnn-devel-ubuntu24.04

%environment
    export DEBIAN_FRONTEND=noninteractive
    export TZ=America/New_York
    export PATH="/usr/local/cuda/bin:/usr/local/bin:/opt/venv/bin:${PATH}"
    export LD_LIBRARY_PATH="/usr/local/cuda/lib64:${LD_LIBRARY_PATH}"
    export PYTHONPATH="/opt/app/src:${PYTHONPATH}"

%files
    docker/darknet/build_darknet.sh    /usr/local/bin/build_darknet.sh
    src                                /opt/app/

%post
    export DEBIAN_FRONTEND=noninteractive
    export TZ=America/New_York
    ln -fs /usr/share/zoneinfo/America/New_York /etc/localtime
    echo "America/New_York" > /etc/timezone
    apt-get update && apt-get install -y tzdata
    apt-get update && apt-get install -y build-essential git libopencv-dev file cmake python3-pip python3-venv fio
    python3 -m venv /opt/venv
    . /opt/venv/bin/activate
    pip install --upgrade pip
    pip install "cmake>=3.24"
    pip install cloudmesh-common PyYAML Pillow pycocotools imagesize git+https://github.com/cloudmesh/cloudmesh-gpu.git
    mkdir -p /workspace /outputs /workspace/.cache/splits
    chmod +x /usr/local/bin/build_darknet.sh

%runscript
    . /opt/venv/bin/activate
    /usr/local/bin/build_darknet.sh
    exec python -u -m yolobattle.model_training.train "$@"
